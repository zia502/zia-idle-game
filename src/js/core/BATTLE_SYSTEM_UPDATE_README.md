# 战斗系统更新说明

本更新扩展了战斗系统，使其能够处理所有技能效果类型。

## 更新内容

1. 添加了对以下效果类型的支持：
   - 回合结束时触发的效果（`endOfTurn`）
   - 回合开始时触发的效果（`startOfTurn`）
   - 攻击时概率触发的效果（`proc`，如`multiShot`）
   - 伤害上限（`damageCap`）
   - 元素转换（`elementConversion`）
   - 复活效果（`revive`）
   - 援护效果（`cover`）
   - 反击效果（`counterAttack`）
   - 忽略DEBUFF效果（`ignoreDebuff`）
   - 持续恢复效果（`regen`）
   - 全属性提升（`allStatsUp`）

2. 扩展了BUFF系统，添加了新的BUFF类型和处理方法

3. 扩展了战斗系统，添加了新的处理方法和逻辑

## 如何应用更新

### 方法1：使用整合文件（推荐）

1. 在游戏初始化时，引入并调用整合文件：

```html
<script src="./src/js/core/battle-system-integration.js"></script>
```

2. 在游戏初始化函数中调用：

```javascript
// 在游戏初始化时调用
function initGame() {
    // 其他初始化代码...

    // 应用战斗系统更新
    initBattleSystemUpdates();

    // 其他初始化代码...
}
```

### 方法2：手动整合

如果您想手动整合更新，可以参考以下文件中的代码：

- `battle-system-update.js`：包含战斗系统的更新
- `buff-system-update.js`：包含BUFF系统的更新

然后将这些更新手动整合到您的代码中。

## 修改战斗循环

无论使用哪种方法，您都需要修改战斗循环，在回合结束时处理回合结束效果。在`Battle.processBattle`方法中找到回合结束部分，添加以下代码：

```javascript
// 处理回合结束时的效果
this.processTurnEndEffects(teamMembers, monster);
```

## 测试

应用更新后，建议进行以下测试：

1. 测试回合结束效果（如雷暴技能）
2. 测试回合开始效果（添加一个带有`startOfTurn`效果的技能）
3. 测试攻击概率触发效果（如多重射击、暗影斩、闪光术等技能）
4. 测试伤害上限效果（如盾誓者誓言技能）
5. 测试元素转换效果（如主教座堂技能）
6. 测试复活效果（如复活技能）
7. 测试援护效果（如盾誓者誓言技能）
8. 测试反击效果（如盾誓者誓言技能）
9. 测试忽略DEBUFF效果（如精准射击技能）
10. 测试持续恢复效果（如樵夫之歌技能）
11. 测试全属性提升效果（如樵夫之歌技能）

### 攻击概率触发效果测试示例

以下是一些可以用来测试攻击概率触发效果的技能：

- **多重射击**：攻击时50%概率触发，对敌方单体造成80%-120%伤害
- **暗影斩**：攻击时有15%概率触发，对敌方单体造成250%-350%攻击力的伤害
- **闪光术**：攻击时有30%概率触发，对敌方全体造成100-150%攻击力的伤害
- **寒冰**：攻击时有15%概率发射一支冰箭，造成60%攻击力的冰属性伤害并施加攻击力-10%DEBUFF

## 注意事项

- 本更新不会影响现有功能，只是添加了新的功能
- 如果您已经自定义了战斗系统，可能需要手动整合更新
- 如果遇到问题，请检查控制台错误信息
