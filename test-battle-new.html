<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>队伍战斗测试系统</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3, h4 {
            color: #333;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        .battle-log {
            border: 1px solid #ccc;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            background-color: #f9f9f9;
            font-family: monospace;
            font-size: 14px;
            border-radius: 4px;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            margin-right: 10px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .character-selection-area, .boss-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        .character-card, .boss-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            width: 200px; /* Adjust width as needed */
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f9f9f9;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        .character-card:hover, .boss-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .character-card.selected, .boss-card.selected {
            border-color: #4CAF50;
            background-color: #e8f5e9;
            box-shadow: 0 2px 5px rgba(76, 175, 80, 0.4);
        }
        .character-card h3, .boss-card h3 {
            margin-top: 0;
            margin-bottom: 8px; /* Add some space below title */
            font-size: 1.1em; /* Slightly larger title */
        }
        .character-card p, .boss-card p {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px; /* Consistent spacing */
        }
        .skills-list {
            margin-top: 10px;
            padding-left: 0; /* Remove default padding */
            list-style-type: none; /* Remove bullets */
        }
        .skill-item {
            background-color: #eee;
            padding: 3px 8px; /* Adjust padding */
            margin: 4px 0; /* Adjust margin */
            border-radius: 4px;
            font-size: 13px; /* Slightly smaller skill font */
            display: inline-block; /* Make skills appear inline */
            margin-right: 5px; /* Space between inline skills */
        }
        .selected-team-area {
            margin-bottom: 20px;
            padding: 15px; /* Increased padding */
            border: 1px solid #ccc;
            border-radius: 8px; /* Match section radius */
            background-color: #f9f9f9;
            min-height: 50px; /* Ensure area is visible even when empty */
        }
        .selected-team-member {
            display: inline-block;
            padding: 6px 12px; /* Increased padding */
            margin: 5px;
            background-color: #4CAF50; /* Use theme color */
            color: white; /* White text */
            border-radius: 15px; /* Pill shape */
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .battle-status {
            display: flex;
            justify-content: space-between;
            gap: 20px; /* Add gap between player and boss status */
            margin-bottom: 20px;
        }
        .character-status, .boss-status {
            flex: 1;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .team-member-status-item {
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .team-member-status-item:last-child {
            border-bottom: none;
        }
        .hp-bar {
            height: 15px; /* Slightly thinner bar */
            background-color: #e0e0e0;
            border-radius: 10px;
            margin-top: 5px;
            overflow: hidden;
        }
        .hp-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 100%;
            transition: width 0.3s ease-in-out; /* Smoother transition */
            border-radius: 10px;
        }
        .boss-hp-fill {
            background-color: #f44336;
        }
        .instructions {
            background-color: #e3f2fd; /* Light blue background */
            border: 1px solid #bbdefb; /* Blue border */
            color: #1e88e5; /* Blue text */
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .hidden {
            display: none;
        }
        @media (max-width: 768px) {
            .character-card, .boss-card {
                width: calc(50% - 10px); /* Two cards per row on smaller screens */
            }
            .battle-status {
                flex-direction: column;
                gap: 15px;
            }
        }
         @media (max-width: 480px) {
            .character-card, .boss-card {
                width: 100%; /* One card per row on very small screens */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>队伍战斗测试系统</h1>

        <div class="instructions">
            <h3>使用说明</h3>
            <p>选择 1 至 <span id="max-team-size-display-instr">4</span> 名角色组成你的队伍，然后选择一个 BOSS 进行战斗模拟。</p>
            <p>点击角色卡片进行选择/取消选择，点击 BOSS 卡片进行选择。选好后点击“开始战斗”。</p>
        </div>

        <div class="section">
            <h2>选择角色 (最多 <span id="max-team-size-display">4</span> 名)</h2>
            <div class="character-selection-area" id="character-selection">
                <div>
                    <label for="category-select">选择类型/稀有度:</label>
                    <select id="category-select">
                        <option value="">--选择类型/稀有度--</option>
                        <option value="R">R</option>
                        <option value="SR">SR</option>
                        <option value="SSR">SSR</option>
                        <option value="JOB">职业 (主角专属)</option>
                    </select>
                </div>
                <div>
                    <label for="character-job-select">选择角色/职业:</label>
                    <select id="character-job-select" disabled>
                        <option value="">--先选择类型/稀有度--</option>
                    </select>
                </div>
                <div id="no-character-prompt" style="color: red; display: none; margin-top: 5px;">
                    该条件下没有可用角色/职业。
                </div>
                <button id="add-character-btn" disabled style="margin-top: 10px;">添加到队伍</button>
            </div>
        </div>

        <div class="section">
            <h2>已选队伍</h2>
            <div class="selected-team-area" id="selected-team-display">
                <p>尚未选择任何角色。</p>
            </div>
        </div>

        <div class="section">
            <h2>选择BOSS</h2>
            <div class="boss-selection" id="boss-selection">
                <!-- BOSS卡片将通过JavaScript动态添加 -->
                 <div class="boss-card"><h3>加载中...</h3></div>
            </div>
        </div>

        <div class="section" id="weapon-board-config-section">
            <h2>配置武器盘</h2>
            <div class="controls">
                <button id="add-weapon-to-board-btn">添加武器到盘</button>
                <button id="apply-weapon-board-btn" disabled>应用武器盘到队伍</button>
                <button id="clear-weapon-board-btn">清空武器盘</button>
            </div>
            <div id="weapon-selection-modal" class="hidden" style="border:1px solid #ccc; padding:15px; margin-top:15px; background:#fff; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000; width:80%; max-width:600px; max-height: 80vh; overflow-y:auto;">
                <h3>选择武器并配置</h3>
                <label for="weapon-select-dropdown">选择武器:</label>
                <select id="weapon-select-dropdown" style="width:100%; margin-bottom:10px;"></select>
                <br>
                <label for="weapon-level-input">武器等级 (1-150):</label>
                <input type="number" id="weapon-level-input" value="100" min="1" max="150" style="margin-bottom:10px;">
                <br>
                <label for="weapon-slot-select">选择槽位:</label>
                <select id="weapon-slot-select" style="margin-bottom:10px;">
                    <option value="mainHand">主手</option>
                    <option value="subHand">副手</option>
                    <option value="slot_0">槽位 1</option>
                    <option value="slot_1">槽位 2</option>
                    <option value="slot_2">槽位 3</option>
                    <option value="slot_3">槽位 4</option>
                    <option value="slot_4">槽位 5</option>
                    <option value="slot_5">槽位 6</option>
                    <option value="slot_6">槽位 7</option>
                    <option value="slot_7">槽位 8</option>
                    <option value="slot_8">槽位 9</option>
                    <option value="slot_9">槽位 10</option>
                </select>
                <br>
                <button id="confirm-add-weapon-btn">确认添加</button>
                <button id="cancel-add-weapon-btn" style="margin-left:10px;">取消</button>
            </div>
            <div id="current-weapon-board-display" style="margin-top:15px; border:1px dashed #ddd; padding:10px; min-height:50px;">
                <p>当前武器盘为空。</p>
            </div>
        </div>

        <div class="section hidden" id="battle-section">
            <h2>战斗状态</h2>
            <div class="battle-status">
                <div class="character-status">
                    <h3 id="player-team-name">玩家队伍</h3>
                    <p>状态: <span id="player-team-status">-</span></p>
                    <div id="player-team-members-status">
                        <!-- 队伍成员状态将动态填充 -->
                    </div>
                </div>
                <div class="boss-status">
                    <h3 id="boss-name">BOSS</h3>
                    <p>属性: <span id="boss-attribute">-</span></p>
                    <p>生命值: <span id="boss-hp">0</span>/<span id="boss-max-hp">0</span></p>
                    <div class="hp-bar">
                        <div class="hp-fill boss-hp-fill" id="boss-hp-fill"></div>
                    </div>
                    <p>攻击力: <span id="boss-attack">0</span></p>
                    <p>防御力: <span id="boss-defense">0</span>%</p>
                    <p>速度: <span id="boss-speed">0</span></p>
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="start-battle" disabled>开始战斗</button>
            <button id="reset">重置</button>
        </div>

        <div class="battle-log" id="battle-log"></div>
    </div>

    <!-- 核心游戏系统 -->
    <script src="src/js/core/game.js"></script>
    <script src="src/js/core/character.js"></script>
    <script src="src/js/core/weapon.js"></script>
    <script src="src/js/core/team.js"></script> <!-- 引入 team.js -->
    <script src="src/js/core/battle.js"></script>
    <script src="src/js/core/buff-system.js"></script>
    <script src="src/js/core/job-system.js"></script>
    <script src="src/js/core/job-skills.js"></script>
    <script src="src/js/core/job-skills-template.js"></script>


    <!-- 游戏组件 -->
    <script src="src/js/components/ui.js"></script>
    <script src="src/js/components/events.js"></script>

    <!-- 战斗系统更新 (如果需要) -->
    <script src="src/js/core/battle-system-integration.js"></script>

    <!-- 技能测试 (如果需要) -->
    <!-- <div id="skill-test-container" style="border: 1px solid blue; padding: 10px; margin-top: 20px;"></div> -->
    <!-- <script src="src/js/demo/skill-test.js"></script> -->

    <script>
        // 战斗测试脚本 (IIFE)
        (function() {
            // --- 全局变量 ---
            let selectedPlayerTeamData = []; // 存储选择的角色原始数据 {id, name, level, ...}
            let playerTeamInstances = []; // 存储实例化的角色对象 [Character, ...]
            let selectedBossData = null;    // 存储选择的BOSS原始数据 {id, name, ...}
            let bossInstance = null;        // 存储实例化的BOSS对象 Character
            let battleInProgress = false;
            let turnCount = 0;
            const MAX_TEAM_SIZE = 4;
            const MAX_WEAPON_SLOTS = 10; // 假设武器盘最多10个普通槽位

            let allCharactersData = {}; // 合并存储 R, SR, SSR 角色和职业数据
            let allWeaponsData = {}; // 存储从 weapons.json 加载的武器数据
            let currentWeaponBoardConfig = { // 存储当前配置的武器盘
                mainHand: null, // { weaponId: 'id', weaponData:{...}, level: 100 }
                subHand: null,
                slots: new Array(MAX_WEAPON_SLOTS).fill(null)
            };
            let tempTeamForWeaponBoard = null; // 存储临时的Team实例用于武器盘

            // --- DOM 元素缓存 ---
            const battleLog = document.getElementById('battle-log');
            const characterSelectionContainer = document.getElementById('character-selection'); // This div will now hold the dropdowns
            const categorySelect = document.getElementById('category-select'); // Updated ID
            const characterJobSelect = document.getElementById('character-job-select'); // Updated ID
            const noCharacterPrompt = document.getElementById('no-character-prompt'); // New prompt element
            const addCharacterBtn = document.getElementById('add-character-btn');
            const selectedTeamDisplay = document.getElementById('selected-team-display');
            const bossSelectionContainer = document.getElementById('boss-selection');
            const startBattleBtn = document.getElementById('start-battle');
            const resetBtn = document.getElementById('reset');
            const battleSection = document.getElementById('battle-section');
            // 玩家队伍状态元素
            const playerTeamName = document.getElementById('player-team-name');
            const playerTeamStatus = document.getElementById('player-team-status');
            const playerTeamMembersStatusContainer = document.getElementById('player-team-members-status');
            // BOSS状态元素
            const bossName = document.getElementById('boss-name');
            const bossHp = document.getElementById('boss-hp');
            const bossMaxHp = document.getElementById('boss-max-hp');
            const bossHpFill = document.getElementById('boss-hp-fill');
            const bossAttack = document.getElementById('boss-attack');
            const bossDefense = document.getElementById('boss-defense');
            const bossSpeed = document.getElementById('boss-speed');
            const bossAttribute = document.getElementById('boss-attribute');
            // UI 显示最大队伍数量
            if (document.getElementById('max-team-size-display')) {
                document.getElementById('max-team-size-display').textContent = MAX_TEAM_SIZE;
            }
             if (document.getElementById('max-team-size-display-instr')) {
                 document.getElementById('max-team-size-display-instr').textContent = MAX_TEAM_SIZE;
             }
             // 武器盘配置相关DOM
             const addWeaponToBoardBtn = document.getElementById('add-weapon-to-board-btn');
             const applyWeaponBoardBtn = document.getElementById('apply-weapon-board-btn');
             const clearWeaponBoardBtn = document.getElementById('clear-weapon-board-btn');
             const weaponSelectionModal = document.getElementById('weapon-selection-modal');
             const weaponSelectDropdown = document.getElementById('weapon-select-dropdown');
             const weaponLevelInput = document.getElementById('weapon-level-input');
             const weaponSlotSelect = document.getElementById('weapon-slot-select');
             const confirmAddWeaponBtn = document.getElementById('confirm-add-weapon-btn');
             const cancelAddWeaponBtn = document.getElementById('cancel-add-weapon-btn');
             const currentWeaponBoardDisplay = document.getElementById('current-weapon-board-display');
 
             // --- 静态数据 ---
            // BOSS 数据 (保持硬编码)
            const bosses = [
                { id: 'dragon', name: '远古巨龙', description: '喷吐烈焰的远古巨龙，拥有强大的物理攻击和火焰魔法。', baseStats: { hp: 5000, attack: 150, defense: 50, speed: 30 }, skills: ['dragonBreath', 'tailSwipe', 'fireStorm'], element: 'fire' },
                { id: 'lich', name: '巫妖王', description: '掌控死亡魔法的不死生物，能够召唤亡灵并施放强力诅咒。', baseStats: { hp: 4000, attack: 120, defense: 60, speed: 40 }, skills: ['deathGrip', 'curseOfWeakness', 'soulDrain'], element: 'dark' },
                { id: 'golem', name: '远古石魔像', description: '由远古魔法创造的巨型石魔像，拥有极高的防御力和强力的物理攻击。', baseStats: { hp: 6000, attack: 100, defense: 120, speed: 20 }, skills: ['rockSlide', 'earthShatter', 'stoneArmor'], element: 'earth' },
                { id: 'demonLord', name: '恶魔领主', description: '来自地狱的恶魔领主，擅长混乱魔法和精神控制。', baseStats: { hp: 4500, attack: 180, defense: 70, speed: 50 }, skills: ['chaosBlast', 'mindControl', 'hellfire'], element: 'chaos' }
            ];

            // BOSS 技能数据 (保持硬编码)
            const bossSkills = {
                dragonBreath: { name: '龙息', description: '喷吐烈焰...', type: 'magic', power: 2.0, cooldown: 3, effectType: 'damage', targetType: 'all_enemies', effects: [{ type: 'damage', multiplier: 2.0, element: 'fire' }] },
                tailSwipe: { name: '龙尾横扫', description: '用尾巴横扫...', type: 'attack', power: 1.5, cooldown: 2, effectType: 'damage_and_debuff', targetType: 'all_enemies', effects: [{ type: 'damage', multiplier: 1.5 }, { type: 'speedDown', value: 0.2, duration: 2, chance: 0.5 }] },
                fireStorm: { name: '烈焰风暴', description: '召唤烈焰风暴...', type: 'magic', power: 1.0, cooldown: 4, effectType: 'damage_and_debuff', targetType: 'all_enemies', effects: [{ type: 'damage', multiplier: 1.0 }, { type: 'dot', value: 200, duration: 3, name: '灼烧', description: '每回合受到火焰伤害' }] },
                deathGrip: { name: '死亡之握', description: '用死亡能量抓住敌人...', type: 'magic', power: 1.8, cooldown: 3, effectType: 'damage', targetType: 'enemy', effects: [{ type: 'damage', multiplier: 1.8, element: 'dark', lifeSteal: 0.3 }] },
                curseOfWeakness: { name: '衰弱诅咒', description: '诅咒敌人...', type: 'magic', power: 0.5, cooldown: 4, effectType: 'debuff', targetType: 'all_enemies', effects: [{ type: 'attackDown', value: 0.3, duration: 3 }, { type: 'defenseDown', value: 0.3, duration: 3 }] },
                soulDrain: { name: '灵魂汲取', description: '汲取敌人的灵魂...', type: 'magic', power: 1.5, cooldown: 3, effectType: 'damage', targetType: 'enemy', effects: [{ type: 'damage', multiplier: 1.5, element: 'dark', lifeSteal: 0.5 }] },
                rockSlide: { name: '岩崩', description: '引发岩崩...', type: 'magic', power: 1.7, cooldown: 3, effectType: 'damage', targetType: 'all_enemies', effects: [{ type: 'damage', multiplier: 1.7, element: 'earth' }] },
                earthShatter: { name: '大地震颤', description: '震动大地...', type: 'magic', power: 1.3, cooldown: 4, effectType: 'damage_and_debuff', targetType: 'all_enemies', effects: [{ type: 'damage', multiplier: 1.3, element: 'earth' }, { type: 'stun', duration: 1, chance: 0.3 }] },
                stoneArmor: { name: '石化护甲', description: '增强自身防御力...', type: 'defense', power: 0.5, cooldown: 5, effectType: 'buff', targetType: 'self', effects: [{ type: 'defenseUp', value: 0.5, duration: 3 }, { type: 'damageReflect', value: 0.3, duration: 3 }] },
                chaosBlast: { name: '混沌爆破', description: '释放混沌能量...', type: 'magic', power: 2.2, cooldown: 4, effectType: 'damage', targetType: 'all_enemies', effects: [{ type: 'damage', multiplier: 2.2, element: 'chaos' }] },
                mindControl: { name: '精神控制', description: '控制敌人的精神...', type: 'magic', power: 0.5, cooldown: 5, effectType: 'debuff', targetType: 'enemy', effects: [{ type: 'stun', duration: 2 }] },
                hellfire: { name: '地狱之火', description: '召唤地狱之火...', type: 'magic', power: 1.5, cooldown: 3, effectType: 'damage_and_debuff', targetType: 'all_enemies', effects: [{ type: 'damage', multiplier: 1.5, element: 'fire' }, { type: 'dot', value: 250, duration: 3, name: '地狱火', description: '每回合受到火焰伤害' }] }
            };

            // --- 初始化 ---
            async function init() {
                // 确保核心类已加载
                if (typeof Character === 'undefined' || typeof Team === 'undefined' || typeof Battle === 'undefined' || typeof JobSkills === 'undefined' || typeof JobSystem === 'undefined') {
                    logMessage("错误: 核心脚本 (Character, Team, Battle, JobSkills, JobSystem) 未能完全加载。", 'error');
                    return; // 阻止进一步执行
                }
                // 初始化 JobSystem
                if (typeof JobSystem !== 'undefined' && typeof JobSystem.init === 'function') {
                    JobSystem.init();
                    // 确保 window.JobSystem 指向正确的 JobSystem 对象
                    if (typeof JobSystem !== 'undefined') {
                        window.JobSystem = JobSystem;
                    }
                }
                await loadGameData();
                populateCharacterSelection();
                populateBossSelection();
                logMessage("调用 addEventListeners 之前", "debug");
                addEventListeners();
                logMessage("调用 addEventListeners 之后", "debug");
                updateSelectedTeamDisplay();
                logMessage("系统初始化完成。请选择角色组成队伍和选择一个BOSS。");
            }

            // --- 数据加载 ---
            async function loadGameData() {
                logMessage("开始加载游戏数据...");
                try {
                    const [rData, srData, ssrData, jobSkillsTemplates, weaponsDataResponse] = await Promise.all([
                        fetch('src/data/r.json').then(res => res.ok ? res.json() : {}).catch(e => { logMessage(`加载 r.json 失败: ${e}`, 'error'); return {}; }),
                        fetch('src/data/sr.json').then(res => res.ok ? res.json() : {}).catch(e => { logMessage(`加载 sr.json 失败: ${e}`, 'error'); return {}; }),
                        fetch('src/data/ssr.json').then(res => res.ok ? res.json() : {}).catch(e => { logMessage(`加载 ssr.json 失败: ${e}`, 'error'); return {}; }),
                        fetch('src/data/job-skills-templates.json').then(res => res.ok ? res.json() : {}).catch(e => { logMessage(`加载 job-skills-templates.json 失败: ${e}`, 'error'); return {}; }),
                        fetch('src/data/weapons.json').catch(e => { logMessage(`加载 weapons.json 失败: ${e}`, 'error'); return null; })
                    ]);

                    if (weaponsDataResponse && weaponsDataResponse.ok) {
                        allWeaponsData = await weaponsDataResponse.json();
                        logMessage(`已加载 ${Object.keys(allWeaponsData).length} 个武器数据。`);
                        populateWeaponSelectionDropdown(); // 填充武器选择下拉框
                    } else {
                        logMessage('加载 src/data/weapons.json 失败或响应不正确。武器盘功能可能受限。', 'error');
                        allWeaponsData = {}; // 确保是对象
                    }

                    // 为 R, SR, SSR 角色添加 rarity 属性，然后合并
                    const processCharacterData = (data, rarity) => {
                        if (data && typeof data === 'object') {
                            return Object.fromEntries(
                                Object.entries(data).map(([key, char]) => {
                                    if (char && typeof char === 'object' && !char.rarity) { // 确保 char 是对象且没有 rarity
                                        return [key, { ...char, rarity: rarity, isJob: char.isJob || false }]; // 保留 isJob 或设为 false
                                    }
                                    return [key, char]; // 如果 char 不是对象或已有 rarity，则原样返回
                                })
                            );
                        }
                        return {}; // 如果 data 不是有效对象，返回空对象
                    };

                    const processedRData = processCharacterData(rData, "R");
                    const processedSRData = processCharacterData(srData, "SR");
                    const processedSSRData = processCharacterData(ssrData, "SSR");

                    allCharactersData = { ...processedRData, ...processedSRData, ...processedSSRData };
                    logMessage(`已加载和处理 ${Object.keys(allCharactersData).length} 个 R/SR/SSR 角色数据，并添加了 rarity 属性。`);

                    // 加载职业数据 (如果 JobSystem 可用)
                    if (window.JobSystem && JobSystem.jobs) {
                        // 职业数据将通过 JobSystem.jobs 访问，不再合并到 allCharactersData
                        // 确保 JobSystem.jobs 中的每个职业都有必要的属性
                        Object.values(JobSystem.jobs).forEach(job => {
                            job.isJob = true; // 标记为职业，如果JobSystem内部没有这个标记的话
                            job.description = job.description || `职业特性: ${job.features || '无'}`;
                        });
                        logMessage(`已加载 ${Object.keys(JobSystem.jobs).length} 个职业数据。职业数据可通过 JobSystem.jobs 访问。`);
                    } else {
                         logMessage("JobSystem 或 JobSystem.jobs 不可用，未加载职业数据。", "warning");
                    }

                    // 设置全局技能库 (合并模板技能和BOSS技能)
                    if (!window.JobSystem) window.JobSystem = {};
                    if (!window.JobSystem.SKILLS) window.JobSystem.SKILLS = {};
                    Object.assign(window.JobSystem.SKILLS, jobSkillsTemplates, bossSkills);
                    logMessage(`技能库已设置，包含 ${Object.keys(window.JobSystem.SKILLS).length} 个技能定义。`);

                } catch (error) {
                    logMessage(`错误: 加载游戏数据时发生严重错误: ${error}`, 'error');
                    console.error("加载游戏数据失败:", error);
                }
                 logMessage("游戏数据加载完成。");
            }

            // --- 武器选择下拉框填充 ---
            function populateWeaponSelectionDropdown() {
                if (!weaponSelectDropdown) {
                    logMessage("错误: 武器选择下拉框元素未找到。", "error");
                    return;
                }
                weaponSelectDropdown.innerHTML = ''; // 清空现有选项

                if (!allWeaponsData || Object.keys(allWeaponsData).length === 0) {
                    logMessage("武器数据为空或未加载，无法填充武器选择下拉框。", "warning");
                    const defaultOption = document.createElement('option');
                    defaultOption.textContent = "无可用武器";
                    defaultOption.disabled = true;
                    weaponSelectDropdown.appendChild(defaultOption);
                    return;
                }

                logMessage(`开始填充武器选择下拉框，共 ${Object.keys(allWeaponsData).length} 个武器。`);
                for (const weaponId in allWeaponsData) {
                    if (allWeaponsData.hasOwnProperty(weaponId)) {
                        const weapon = allWeaponsData[weaponId];
                        const option = document.createElement('option');
                        option.value = weaponId;
                        option.textContent = `${weapon.name} (${weapon.type || '未知类型'})`; // 显示武器名称和类型
                        weaponSelectDropdown.appendChild(option);
                    }
                }
                logMessage("武器选择下拉框填充完成。");
            }

            // --- UI 填充 (角色/职业选择修改为新的下拉列表逻辑) ---
            function populateCharacterSelection() {
                // categorySelect 选项已在HTML中定义 (R, SR, SSR, JOB)
                // 初始化时，characterJobSelect 和 addCharacterBtn 是禁用的
                characterJobSelect.innerHTML = '<option value="">--先选择类型/稀有度--</option>';
                characterJobSelect.disabled = true;
                addCharacterBtn.disabled = true;
                noCharacterPrompt.style.display = 'none';

                // Event listeners will be in addEventListeners function
            }

            function updateCharacterJobSelect() {
                const selectedCategory = categorySelect.value;
                characterJobSelect.innerHTML = ''; // 清空选项
                characterJobSelect.disabled = true;
                addCharacterBtn.disabled = true;
                noCharacterPrompt.style.display = 'none'; // 先隐藏提示

                let optionsAvailable = false;
                let promptMessage = '--该条件下无可用选项--'; // 默认提示

                if (selectedCategory === "R" || selectedCategory === "SR" || selectedCategory === "SSR") {
                    logMessage(`Filtering characters for rarity: ${selectedCategory}. Total characters in allCharactersData: ${Object.keys(allCharactersData).length}`);
                    const charactersOfRarity = Object.values(allCharactersData).filter(c => c.rarity === selectedCategory && !c.isJob);
                    logMessage(`Found ${charactersOfRarity.length} characters for rarity ${selectedCategory}.`);

                    if (charactersOfRarity.length > 0) {
                        characterJobSelect.appendChild(new Option(`--选择 ${selectedCategory} 角色--`, ""));
                        charactersOfRarity.forEach(char => {
                            const option = new Option(`${char.name} (${char.type || '未知类型'})`, char.id);
                            characterJobSelect.appendChild(option);
                        });
                        characterJobSelect.disabled = false;
                        optionsAvailable = true;
                    } else {
                        promptMessage = `--该稀有度 (${selectedCategory}) 下无角色--`;
                    }
                } else if (selectedCategory === "JOB") {
                    logMessage("Populating jobs. Checking JobSystem.jobs...");
                    if (window.JobSystem && JobSystem.jobs && Object.keys(JobSystem.jobs).length > 0) {
                        characterJobSelect.appendChild(new Option('--选择职业--', ""));
                        Object.values(JobSystem.jobs).forEach(job => {
                            logMessage(`Adding job option: Name='${job.name}', ID='${job.id}' (type: ${typeof job.id})`);
                            const option = new Option(job.name, String(job.id)); // 确保 option.value 是字符串
                            characterJobSelect.appendChild(option);
                        });
                        characterJobSelect.disabled = false;
                        optionsAvailable = true;
                    } else {
                        logMessage("No job data found in JobSystem.jobs.");
                        promptMessage = '--无可用职业数据--';
                    }
                }

                if (!optionsAvailable && selectedCategory) {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = promptMessage;
                    characterJobSelect.appendChild(option);
                    noCharacterPrompt.textContent = promptMessage;
                    noCharacterPrompt.style.display = 'block'; // 显示自定义提示
                } else if (!selectedCategory) {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = '--先选择类型/稀有度--';
                    characterJobSelect.appendChild(option);
                }

                // 如果有选项（非提示信息），则第一个空值选项不应被选中
                if (optionsAvailable && characterJobSelect.options.length > 1 && characterJobSelect.options[0].value === "") {
                   characterJobSelect.selectedIndex = 0; // 保持默认 "--选择..."
                } else if (!optionsAvailable && selectedCategory) {
                    characterJobSelect.selectedIndex = 0; // 选中提示信息
                } else if (!selectedCategory) {
                    characterJobSelect.selectedIndex = 0; // 选中 "--先选择类型/稀有度--"
                }
                // characterJobSelect.value = ""; // 确保此行已注释或移除

                // 手动触发change事件以更新按钮状态
                const event = new Event('change');
                characterJobSelect.dispatchEvent(event);
            }

            function handleAddCharacterToTeam() {
                const selectedCategoryValue = categorySelect.value;
                const selectedItemValue = characterJobSelect.value;

                if (!selectedItemValue) {
                    logMessage("请先选择一个角色或职业。", "warning");
                    return;
                }

                if (selectedCategoryValue === "JOB") {
                    // 处理添加职业的逻辑
                    const selectedJobId = selectedItemValue; // This will be a string from select.value
                    logMessage(`Attempting to add job. Selected category: JOB, selectedJobId from dropdown: '${selectedJobId}' (type: ${typeof selectedJobId})`);
                    
                    let jobData = null;
                    if (JobSystem && JobSystem.jobs) {
                        logMessage(`handleAddCharacterToTeam: Available job IDs in JobSystem.jobs: ${Object.keys(JobSystem.jobs).map(id => `'${id}' (type: ${typeof JobSystem.jobs[id].id})`).join(', ')}`);
                        // selectedJobId is already a string. JobSystem.jobs keys should ideally be strings or handled consistently.
                        // If JobSystem.jobs keys are numbers, this direct access might fail if selectedJobId is "1" and key is 1.
                        // The change in updateCharacterJobSelect to use String(job.id) for option value should make selectedJobId always a string.
                        jobData = JobSystem.jobs[selectedJobId];
                        logMessage(`handleAddCharacterToTeam: Looked up jobData for ID '${selectedJobId}'. Found: ${JSON.stringify(jobData ? {name: jobData.name, id: jobData.id} : null)}`);

                        // Fallback check if job IDs in JobSystem.jobs might be numbers or if keys are not direct IDs
                        if (!jobData) {
                            logMessage(`handleAddCharacterToTeam: jobData not found with string key '${selectedJobId}'. Trying to find by matching String(job.id).`);
                            for (const jobIdKey in JobSystem.jobs) {
                                if (JobSystem.jobs.hasOwnProperty(jobIdKey) && String(JobSystem.jobs[jobIdKey].id) === selectedJobId) {
                                    jobData = JobSystem.jobs[jobIdKey];
                                    logMessage(`handleAddCharacterToTeam: Found jobData by comparing String(job.id) with '${selectedJobId}'. Job: ${jobData.name}`);
                                    break;
                                }
                            }
                        }

                    } else {
                        logMessage(`handleAddCharacterToTeam: JobSystem.jobs is not available.`, 'error');
                    }
                    // const jobData = JobSystem.jobs[selectedJobId]; // Moved lookup up

                    if (!jobData) {
                        logMessage(`错误：找不到职业数据 ID: '${selectedJobId}'. jobData is ${jobData}. Available job IDs in JobSystem.jobs: ${JobSystem && JobSystem.jobs ? Object.values(JobSystem.jobs).map(j => j.id).join(', ') : 'JobSystem.jobs not available'}`, "error");
                        return;
                    }

                    if (selectedPlayerTeamData.length === 0) {
                        logMessage("请先添加一个角色作为主角，然后才能为其分配职业。", "warn");
                        return;
                    }

                    const mainCharacterData = selectedPlayerTeamData[0]; // 假定第一个角色是主角
                    if (mainCharacterData.jobId) {
                        logMessage(`主角 ${mainCharacterData.name} 已有职业 (${mainCharacterData.jobName || '未知职业'})。如需更换，请先移除角色或等待后续实现职业更换功能。`, "warn");
                        return;
                    }

                    // 为主角应用职业
                    mainCharacterData.jobId = selectedJobId;
                    mainCharacterData.jobName = jobData.name;
                    // 合并技能 (确保不重复)
                    mainCharacterData.skills = [...new Set([...(mainCharacterData.skills || []), ...(jobData.skills || [])])];
                    // 合并或覆盖属性 (根据JobSystem设计)
                    // 假设 jobData.statModifiers 是一个对象，如 { attack: 10, defense: 5 }
                    if (jobData.statModifiers) {
                        for (const stat in jobData.statModifiers) {
                            mainCharacterData.baseStats[stat] = (mainCharacterData.baseStats[stat] || 0) + jobData.statModifiers[stat];
                        }
                    }
                    // 如果职业有特定元素或类型，也可以在这里更新
                    // mainCharacterData.element = jobData.element || mainCharacterData.element;
                    // mainCharacterData.type = jobData.jobType || mainCharacterData.type;


                    logMessage(`已为主角 ${mainCharacterData.name} 设置职业: ${jobData.name}。`, "success");
                    updateSelectedTeamDisplay(); // 更新队伍显示以反映职业变化

                } else {
                    // 处理添加角色的逻辑 (R, SR, SSR)
                    const selectedCharId = selectedItemValue;
                    const charDataOriginal = allCharactersData[selectedCharId];

                    if (!charDataOriginal) {
                        logMessage(`错误：找不到ID为 ${selectedCharId} 的角色数据。`, "error");
                        return;
                    }

                    if (selectedPlayerTeamData.length >= MAX_TEAM_SIZE) {
                        logMessage(`队伍已满 (最多 ${MAX_TEAM_SIZE} 名)，无法添加 ${charDataOriginal.name}。`, 'warning');
                        return;
                    }

                    // 检查角色是否已在队伍中 (基于原始ID)
                    if (selectedPlayerTeamData.some(member => member.originalId === charDataOriginal.id || member.id === charDataOriginal.id)) {
                        logMessage(`角色 ${charDataOriginal.name} 已在队伍中。`, "warning");
                        return;
                    }

                    const characterData = JSON.parse(JSON.stringify(charDataOriginal));
                    characterData.originalId = charDataOriginal.id; // 保存原始ID，用于去重等
                    // 为队伍中的角色生成唯一ID，以允许添加多个同名但不同实例的角色（如果需要）
                    // 但当前逻辑是基于原始ID去重，所以暂时不需要队伍内唯一ID不同于原始ID
                    // characterData.id = `${charDataOriginal.id}_${Date.now()}`;
                    characterData.level = characterData.level || 1;
                    characterData.jobId = null; // 新添加的角色默认无职业
                    characterData.jobName = null;

                    selectedPlayerTeamData.push(characterData);
                    logMessage(`${characterData.name} (等级: ${characterData.level}) 已添加到队伍。 (队伍: ${selectedPlayerTeamData.length}/${MAX_TEAM_SIZE})`, "success");
                    updateSelectedTeamDisplay();
                }

                // 重置选择并禁用按钮
                categorySelect.value = "";
                characterJobSelect.innerHTML = '<option value="">--先选择类型/稀有度--</option>';
                characterJobSelect.disabled = true;
                characterJobSelect.value = "";
                addCharacterBtn.disabled = true;
                noCharacterPrompt.style.display = 'none';
                checkSelections(); // 更新开始战斗按钮的状态
            }

            // getRaritySortValue 不再直接用于 populateCharacterSelection，但可能在其他地方有用
            function getRaritySortValue(charData) {
                if (!charData) return 0;
                // 优先使用显式稀有度属性
                if (charData.rarity === 'SSR') return 4;
                if (charData.rarity === 'SR') return 3;
                if (charData.rarity === 'R') return 2;
                // 然后尝试通过ID前缀推断
                if (charData.id.startsWith('ssr_')) return 4;
                if (charData.id.startsWith('sr_')) return 3;
                if (charData.id.startsWith('r_')) return 2;
                if (charData.isJob) return 1;
                return 0;
            }

            function populateBossSelection() {
                bossSelectionContainer.innerHTML = ''; // 清空
                bosses.forEach(bossData => {
                    const card = createSelectableCard(bossData, 'boss');
                    bossSelectionContainer.appendChild(card);
                });
            }

            // --- 卡片创建 ---
            function createSelectableCard(data, type) {
                const card = document.createElement('div');
                card.classList.add(type === 'character' ? 'character-card' : 'boss-card');
                card.dataset.id = data.id;

                // 确定稀有度
                let rarity = data.rarity;
                if (!rarity) {
                    if (data.id.startsWith('ssr_')) rarity = 'SSR';
                    else if (data.id.startsWith('sr_')) rarity = 'SR';
                    else if (data.id.startsWith('r_')) rarity = 'R';
                    else if (data.isJob) rarity = '职业';
                    else rarity = 'N/A'; // BOSS 或其他
                }
                card.dataset.rarity = rarity;

                // 名称
                const nameEl = document.createElement('h3');
                nameEl.textContent = data.name;
                card.appendChild(nameEl);

                // 描述
                const descText = data.description || `属性: ${data.attribute || data.element || 'N/A'}, 类型: ${data.type || 'N/A'}`;
                const descEl = document.createElement('p');
                descEl.textContent = descText.substring(0, 60) + (descText.length > 60 ? '...' : ''); // 增加描述长度
                descEl.title = descText; // 完整描述悬浮显示
                card.appendChild(descEl);

                // 稀有度/类型 显示
                const infoEl = document.createElement('p');
                infoEl.textContent = `${rarity} / ${data.type || '未知类型'}`;
                infoEl.style.fontSize = '13px';
                infoEl.style.color = '#555';
                card.appendChild(infoEl);

                // 技能列表
                if (data.skills && data.skills.length > 0) {
                    const skillsTitle = document.createElement('h4');
                    skillsTitle.textContent = '主要技能:';
                    skillsTitle.style.cssText = 'font-size: 14px; margin-top: 8px; margin-bottom: 4px;';
                    card.appendChild(skillsTitle);

                    const skillsListEl = document.createElement('ul');
                    skillsListEl.classList.add('skills-list'); // 使用 class
                    data.skills.slice(0, 2).forEach(skillIdentifier => { // 显示前两个技能
                        let skillName = '未知技能';
                        let skillDesc = '无描述';
                        // 优先从全局技能库查找
                        const skillData = (window.JobSystem && JobSystem.SKILLS && JobSystem.SKILLS[skillIdentifier]) || bossSkills[skillIdentifier];

                        if (skillData) {
                            skillName = skillData.name;
                            skillDesc = skillData.description;
                        } else if (typeof skillIdentifier === 'string') {
                            skillName = skillIdentifier; // Fallback to ID if not found
                        }

                        const skillItem = document.createElement('li');
                        skillItem.classList.add('skill-item'); // 使用 class
                        skillItem.textContent = skillName;
                        skillItem.title = skillDesc;
                        skillsListEl.appendChild(skillItem);
                    });
                    card.appendChild(skillsListEl);
                }

                // 添加点击事件
                card.addEventListener('click', () => handleSelection(card, data, type));
                return card;
            }

            // --- 选择处理 (旧的 handleSelection 主要处理卡片点击，现在角色选择通过下拉框和按钮) ---
            // handleSelection 函数现在主要用于处理 BOSS 的选择，角色选择已移至 handleAddCharacterToTeam
            function handleSelection(card, data, type) {
                if (battleInProgress) return;
                const selectedClass = 'selected';

                if (type === 'boss') {
                    // BOSS 单选逻辑
                    const currentlySelected = bossSelectionContainer.querySelector('.boss-card.selected');
                    if (currentlySelected === card) { // 点击已选中的BOSS -> 取消选择
                         card.classList.remove(selectedClass);
                         selectedBossData = null;
                         logMessage(`取消选择BOSS: ${data.name}`);
                    } else { // 选择新的BOSS
                        if(currentlySelected) currentlySelected.classList.remove(selectedClass);
                        card.classList.add(selectedClass);
                        selectedBossData = data;
                        logMessage(`选择BOSS: ${data.name}`);
                    }
                }
                // 角色选择现在由 handleAddCharacterToTeam 处理
                // updateSelectedTeamDisplay(); // 这个会在 handleAddCharacterToTeam 中调用
                checkSelections(); // 检查是否可以开始战斗
            }

            // 更新已选队伍区域显示
            function updateSelectedTeamDisplay() {
                selectedTeamDisplay.innerHTML = ''; // 清空
                if (selectedPlayerTeamData.length === 0) {
                    selectedTeamDisplay.innerHTML = '<p>尚未选择任何角色。</p>';
                } else {
                    selectedPlayerTeamData.forEach((memberData, index) => {
                        const memberContainer = document.createElement('div');
                        memberContainer.style.display = 'flex';
                        memberContainer.style.alignItems = 'center';
                        memberContainer.style.marginBottom = '5px';

                        const memberNameSpan = document.createElement('span');
                        memberNameSpan.classList.add('selected-team-member');
                        memberNameSpan.textContent = memberData.name;
                        memberNameSpan.style.marginRight = '10px';
                        memberContainer.appendChild(memberNameSpan);

                        const levelLabel = document.createElement('label');
                        levelLabel.textContent = '等级: ';
                        levelLabel.style.marginRight = '5px';
                        memberContainer.appendChild(levelLabel);

                        const levelInput = document.createElement('input');
                        levelInput.type = 'number';
                        levelInput.value = memberData.level || 1;
                        levelInput.min = 1;
                        // 尝试从角色数据中获取最大等级，如果 Character.rarities 可用
                        let maxLevel = 100; // Default max level
                        if (typeof Character !== 'undefined' && Character.rarities) {
                            const rarityKey = memberData.rarity // e.g., "SSR", "SR", "R" or "职业"
                                                ? (memberData.rarity.toLowerCase() === 'ssr' ? 'legendary' :
                                                  memberData.rarity.toLowerCase() === 'sr' ? 'epic' :
                                                  memberData.rarity.toLowerCase() === 'r' ? 'rare' :
                                                  null)
                                                : null;
                            if (rarityKey && Character.rarities[rarityKey]) {
                                maxLevel = Character.rarities[rarityKey].maxLevel || 100;
                            } else if (memberData.isJob) { // Handle "职业" if not mapped above
                                // Assuming jobs might have a default max level or it's defined elsewhere
                                // For now, use a generic max if not specifically found
                            }
                        }
                        levelInput.max = maxLevel;
                        levelInput.style.width = '60px';
                        levelInput.dataset.charId = memberData.id;

                        levelInput.addEventListener('change', (event) => {
                            const newLevel = parseInt(event.target.value, 10);
                            const charId = event.target.dataset.charId;
                            const memberIndex = selectedPlayerTeamData.findIndex(m => m.id === charId);
                            if (memberIndex > -1) {
                                if (newLevel >= parseInt(event.target.min) && newLevel <= parseInt(event.target.max)) {
                                    selectedPlayerTeamData[memberIndex].level = newLevel;
                                    logMessage(`角色 ${selectedPlayerTeamData[memberIndex].name} 等级更新为: ${newLevel}`);
                                } else {
                                    event.target.value = selectedPlayerTeamData[memberIndex].level; // Revert to old value
                                    logMessage(`等级 ${newLevel} 无效 (应在 ${event.target.min}-${event.target.max} 之间).`, 'warning');
                                }
                            }
                        });
                        memberContainer.appendChild(levelInput);
                        selectedTeamDisplay.appendChild(memberContainer);
                    });
                }
            }

            // 检查选择状态，启用/禁用开始按钮
            function checkSelections() {
                startBattleBtn.disabled = !(selectedPlayerTeamData.length > 0 && selectedBossData);
            }

            // --- 事件监听 ---
            function addEventListeners() {
                logMessage("进入 addEventListeners 函数", "debug");
                // startBattleBtn, resetBtn, window battleEnd listeners remain
                startBattleBtn.addEventListener('click', handleStartBattle);
                resetBtn.addEventListener('click', resetBattle);
                window.addEventListener('battleEnd', handleBattleEnd);

                // New listeners for character/job selection
                if (categorySelect) {
                    logMessage("尝试为 categorySelect 添加事件监听器", "debug");
                    categorySelect.addEventListener('change', () => {
                        logMessage("categorySelect change 事件触发", "event");
                        updateCharacterJobSelect();
                        // Manually trigger change on characterJobSelect to update button state
                        const event = new Event('change');
                        characterJobSelect.dispatchEvent(event);
                    });
                } else {
                    logMessage("categorySelect 元素未找到，无法添加监听器", "error");
                }

                if (characterJobSelect) {
                    logMessage("尝试为 characterJobSelect 添加事件监听器", "debug");
                    characterJobSelect.addEventListener('change', () => {
                        logMessage("characterJobSelect change 事件触发", "event");
                        const selectedValue = characterJobSelect.value;
                        if (selectedValue) {
                            addCharacterBtn.disabled = false;
                            logMessage("addCharacterBtn 已启用", "debug");
                        } else {
                            addCharacterBtn.disabled = true;
                            logMessage("addCharacterBtn 已禁用", "debug");
                        }
                    });
                } else {
                    logMessage("characterJobSelect 元素未找到，无法添加监听器", "error");
                }

                if (addCharacterBtn) {
                    logMessage("尝试为 addCharacterBtn 添加事件监听器", "debug");
                    addCharacterBtn.addEventListener('click', () => {
                        logMessage("addCharacterBtn click 事件触发", "event");
                        handleAddCharacterToTeam();
                    });
                } else {
                    logMessage("addCharacterBtn 元素未找到，无法添加监听器", "error");
                }
                
                // Weapon board listeners (ensure they are still relevant and correctly placed)
                // Temporarily commented out to fix ReferenceError if functions are not defined in this scope
                /*
                if (addWeaponToBoardBtn) addWeaponToBoardBtn.addEventListener('click', handleOpenWeaponSelectionModal);
                if (confirmAddWeaponBtn) confirmAddWeaponBtn.addEventListener('click', handleConfirmAddWeapon);
                if (cancelAddWeaponBtn) cancelAddWeaponBtn.addEventListener('click', handleCloseWeaponSelectionModal);
                if (applyWeaponBoardBtn) applyWeaponBoardBtn.addEventListener('click', handleApplyWeaponBoardToTeam);
                if (clearWeaponBoardBtn) clearWeaponBoardBtn.addEventListener('click', handleClearWeaponBoard);
                */

            }

            // --- 战斗流程 ---
            async function handleStartBattle() { // <-- Added async here
                if (selectedPlayerTeamData.length === 0 || !selectedBossData || battleInProgress) {
                    logMessage("请至少选择一名角色和一名BOSS。", "warning");
                    return;
                }
                battleInProgress = true;
                startBattleBtn.disabled = true;
                resetBtn.disabled = true; // 禁用重置直到战斗结束
                battleSection.classList.remove('hidden');
                battleLog.innerHTML = ''; // 清空日志
                turnCount = 0;

                if (applyWeaponBoardBtn && !applyWeaponBoardBtn.disabled) {
                    logMessage("武器盘有未应用的更改，将在战斗开始前自动应用。", "info");
                    await handleApplyWeaponBoardToTeam();
                }

                const teamNames = selectedPlayerTeamData.map(m => m.name).join(', ');
                logMessage(`战斗开始! 队伍 [${teamNames}] vs ${selectedBossData.name}`);

                if (playerTeamInstances.length === 0 || playerTeamInstances.length !== selectedPlayerTeamData.length) {
                     logMessage("重新创建战斗角色实例...", "info");
                     playerTeamInstances = selectedPlayerTeamData.map(charDataWithUserLevel => createGameCharacter(charDataWithUserLevel, true)).filter(Boolean);
                }
                if (!bossInstance) {
                    bossInstance = createGameCharacter(selectedBossData, false);
                }

                if (playerTeamInstances.length === 0 || !bossInstance) {
                    logMessage("错误：未能成功创建所有战斗单位。", "error");
                    resetBattle(); // 重置状态
                    return;
                }

                // 更新初始UI状态
                updatePlayerTeamStatusDisplay(playerTeamInstances);
                updateBossStatus(bossInstance);

                // 初始化并开始战斗
                try {
                    const battle = new Battle();
                    const playerTeamForBattle = new Team(playerTeamInstances);
                    const enemyTeamForBattle = new Team([bossInstance]);

                    // 设置战斗更新回调
                    battle.initialize(playerTeamForBattle, enemyTeamForBattle, battleLog, (currentBattleState) => {
                        // 这个回调会在战斗系统内部的某个点被调用，用来更新UI
                        if (currentBattleState.playerTeam) updatePlayerTeamStatusDisplay(currentBattleState.playerTeam.members);
                        if (currentBattleState.enemyTeam && currentBattleState.enemyTeam.members[0]) updateBossStatus(currentBattleState.enemyTeam.members[0]);
                    });

                    battle.start(); // 启动战斗循环
                } catch (error) {
                     logMessage(`战斗初始化或启动时出错: ${error}`, 'error');
                     console.error("Battle start error:", error);
                     resetBattle(); // 出错时重置
                }
            }

            function handleBattleEnd(event) {
                 logMessage("接收到 battleEnd 事件");
                 if (!event.detail || !event.detail.winnerTeam) {
                     logMessage(`战斗结束! 结果未知。`, 'warning');
                 } else {
                     const winnerIsPlayer = event.detail.winnerTeam.isPlayerTeam;
                     // 确保 playerTeamInstances 在这里仍然可用
                     const winnerName = winnerIsPlayer
                                      ? `队伍 [${playerTeamInstances.map(p=>p.name).join(', ')}]`
                                      : (event.detail.winnerTeam.members[0]?.name || "BOSS队");
                     logMessage(`战斗结束! ${winnerName} 胜利!`);
                 }
                 battleInProgress = false;
                 resetBtn.disabled = false; // 战斗结束后启用重置按钮
                 // startBattleBtn 保持禁用，直到用户重置并重新选择
            }


            // --- 实例创建 ---
            function createGameCharacter(charData, isPlayer) {
                if (!charData || !charData.id) {
                    logMessage(`错误: 无效数据提供给 createGameCharacter: ${JSON.stringify(charData)}`, 'error');
                    return null;
                }
                // 查找基础数据 (优先从 allCharactersData 获取，因为可能包含职业数据)
                const baseData = allCharactersData[charData.id] || charData; // Fallback to provided data if not found
                if (!baseData || !baseData.baseStats) {
                     logMessage(`错误: 找不到ID为 '${charData.id}' 的有效基础数据或属性。`, 'error');
                     return null;
                }

                // charData is from selectedPlayerTeamData and includes the user-set 'level'
                // baseData is the original character template (e.g., from r.json, sr.json)

                const targetLevel = charData.level || baseData.level || 1;
                let calculatedStats = JSON.parse(JSON.stringify(baseData.baseStats)); // Start with 1st level stats

                // Calculate stats for the targetLevel if Character class and its properties are available
                if (typeof Character !== 'undefined' && Character.types && Character.rarities && baseData.type && baseData.rarity) {
                    const typeData = Character.types[baseData.type.toLowerCase()]; // Ensure type is lowercase if keys are
                    const rarityKey = baseData.rarity // e.g., "SSR", "SR", "R"
                                        ? (baseData.rarity.toLowerCase() === 'ssr' ? 'legendary' :
                                          baseData.rarity.toLowerCase() === 'sr' ? 'epic' :
                                          baseData.rarity.toLowerCase() === 'r' ? 'rare' :
                                          null)
                                        : null;
                    const rarityData = rarityKey ? Character.rarities[rarityKey] : Character.rarities.rare; // Default to rare if not found

                    if (typeData && typeData.growthRates && rarityData && rarityData.statMultiplier) {
                        const growthRates = typeData.growthRates;
                        const statMultiplier = rarityData.statMultiplier;
                        
                        // Start from level 1 stats and apply growth for each level up to targetLevel
                        for (let lvl = 1; lvl < targetLevel; lvl++) {
                            calculatedStats.hp = Math.floor((calculatedStats.hp || 0) + (growthRates.hp || 0) * statMultiplier);
                            calculatedStats.attack = Math.floor((calculatedStats.attack || 0) + (growthRates.attack || 0) * statMultiplier);
                            calculatedStats.defense = Math.floor((calculatedStats.defense || 0) + (growthRates.defense || 0) * statMultiplier);
                            calculatedStats.speed = Math.floor((calculatedStats.speed || 0) + (growthRates.speed || 0) * statMultiplier);
                            // Add other stats if they grow with level
                        }
                        calculatedStats.maxHp = calculatedStats.hp; // Ensure maxHp is also updated
                    } else {
                        logMessage(`警告: 角色 ${baseData.name} 的类型 (${baseData.type}) 或稀有度 (${baseData.rarity}) 的成长数据未找到，使用基础属性。`, 'warning');
                    }
                } else if (targetLevel > 1) {
                     logMessage(`警告: Character核心数据未完全加载，无法为 ${baseData.name} 计算 ${targetLevel} 级属性，将使用1级属性。`, 'warning');
                }
                
                // 确保 hp 和 maxHp 存在且有效 after calculation
                calculatedStats.hp = Number(calculatedStats.hp) || 100;
                calculatedStats.maxHp = Number(calculatedStats.maxHp) || calculatedStats.hp;

                // 确定稀有度
                let rarityVal = baseData.rarity || charData.rarity;
                if (!rarityVal) {
                    if (baseData.id.startsWith('ssr_')) rarityVal = 'SSR';
                    else if (baseData.id.startsWith('sr_')) rarityVal = 'SR';
                    else if (baseData.id.startsWith('r_')) rarityVal = 'R';
                    else if (baseData.isJob) rarityVal = '职业';
                    else rarityVal = 'N/A';
                }

                // 创建 Character 实例
                const characterInstance = new Character({
                    id: baseData.id,
                    name: baseData.name,
                    attribute: baseData.attribute || baseData.element,
                    type: baseData.type || (isPlayer ? 'player' : 'boss'),
                    stats: calculatedStats, // 使用为目标等级计算的属性
                    skills: [],
                    isPlayer: isPlayer,
                    jobId: baseData.isJob ? baseData.id : undefined,
                    rarity: rarityVal,
                    level: targetLevel // 传递目标等级
                });

                // 加载并实例化技能
                const skillSource = (window.JobSystem && JobSystem.SKILLS) || {}; // 全局技能库
                if (baseData.skills && Array.isArray(baseData.skills)) {
                    baseData.skills.forEach(skillIdentifier => {
                        // 查找技能模板
                        const skillTemplate = skillSource[skillIdentifier] || bossSkills[skillIdentifier]; // 也检查 bossSkills
                        if (skillTemplate) {
                            try {
                                // 创建 Skill 实例
                                const skillInstance = new Skill(skillTemplate, characterInstance, 1); // 默认等级1
                                characterInstance.skills.push(skillInstance);
                            } catch (skillError) {
                                logMessage(`警告: 为 ${baseData.name} 创建技能 '${skillIdentifier}' 时出错: ${skillError}`, 'warning');
                                console.error(`Skill creation error for ${skillIdentifier}:`, skillError);
                            }
                        } else {
                            logMessage(`警告: ${baseData.name} 的技能ID '${skillIdentifier}' 在技能库中未找到。`, 'warning');
                        }
                    });
                }
                // 初始化 buffs 和 debuffs 数组
                characterInstance.buffs = [];
                characterInstance.debuffs = [];

                logMessage(`${isPlayer ? '角色' : 'BOSS'} ${characterInstance.name} (稀有度: ${rarityVal}) 创建成功。`);
                return characterInstance;
            }

            // --- UI 更新 ---
            function updatePlayerTeamStatusDisplay(teamMembers) {
                playerTeamName.textContent = "玩家队伍";
                playerTeamMembersStatusContainer.innerHTML = ''; // 清空旧状态
                if (!teamMembers || teamMembers.length === 0) {
                    playerTeamStatus.textContent = "队伍为空或状态未知。"; return;
                }
                let totalHp = 0, totalMaxHp = 0, aliveMembers = 0;
                teamMembers.forEach(member => {
                    if (member && member.stats) { // 确保成员和属性存在
                        const memberHp = Math.max(0, Math.round(member.stats.hp));
                        const memberMaxHp = Math.round(member.stats.maxHp);
                        totalHp += memberHp; totalMaxHp += memberMaxHp;
                        if (memberHp > 0) aliveMembers++;

                        // 创建每个成员的状态显示
                        const memberStatusDiv = document.createElement('div');
                        memberStatusDiv.classList.add('team-member-status-item');
                        memberStatusDiv.innerHTML = `
                            <strong>${member.name}</strong> (${member.rarity || 'N/A'}) - HP: ${memberHp}/${memberMaxHp}
                            <div class="hp-bar" title="HP: ${memberHp}/${memberMaxHp}">
                                <div class="hp-fill" style="width: ${memberMaxHp > 0 ? (memberHp / memberMaxHp) * 100 : 0}%;"></div>
                            </div>`;
                        playerTeamMembersStatusContainer.appendChild(memberStatusDiv);
                    }
                });
                // 更新队伍整体状态文本
                playerTeamStatus.textContent = totalMaxHp > 0 ? `存活: ${aliveMembers}/${teamMembers.length} | 总HP: ${totalHp}/${totalMaxHp}` : (teamMembers.length > 0 ? "队伍全灭。" : "队伍为空。");
            }

            function updateBossStatus(bossToUpdate) {
                if (!bossToUpdate || !bossToUpdate.stats) {
                    // 设置默认或错误状态
                    bossName.textContent = 'BOSS (状态未知)'; bossHp.textContent = '0'; bossMaxHp.textContent = '0';
                    bossHpFill.style.width = '0%'; bossAttack.textContent = '0'; bossDefense.textContent = '0%'; bossSpeed.textContent = '0';
                    if (bossAttribute) bossAttribute.textContent = '-';
                    return;
                }
                // 更新BOSS信息
                bossName.textContent = bossToUpdate.name;
                const currentBossHp = Math.max(0, Math.round(bossToUpdate.stats.hp));
                const currentBossMaxHp = Math.round(bossToUpdate.stats.maxHp);
                bossHp.textContent = currentBossHp; bossMaxHp.textContent = currentBossMaxHp;
                bossHpFill.style.width = currentBossMaxHp > 0 ? `${(currentBossHp / currentBossMaxHp) * 100}%` : '0%';
                // 获取有效属性，如果方法存在的话
                const effectiveStats = typeof bossToUpdate.getEffectiveStats === 'function' ? bossToUpdate.getEffectiveStats() : bossToUpdate.stats;
                bossAttack.textContent = Math.round(effectiveStats.attack);
                bossDefense.textContent = `${Math.round((effectiveStats.defense || 0) * 100)}%`; // 处理可能的 undefined
                bossSpeed.textContent = Math.round(effectiveStats.speed);
                if (bossAttribute) bossAttribute.textContent = bossToUpdate.attribute || '-';
            }

            // --- 重置 ---
            function resetBattle() {
                logMessage("开始重置战斗...");
                // 停止任何可能的战斗循环 (如果 Battle 类没有完全处理)
                // clearInterval(battleInterval); battleInterval = null;

                battleInProgress = false;
                // 清空选择和实例
                selectedPlayerTeamData = [];
                playerTeamInstances = [];
                selectedBossData = null;
                bossInstance = null;
                turnCount = 0;

                // 清除UI选择状态
                characterSelectionContainer.querySelectorAll('.character-card.selected').forEach(c => c.classList.remove('selected'));
                bossSelectionContainer.querySelectorAll('.boss-card.selected').forEach(c => c.classList.remove('selected'));

                updateSelectedTeamDisplay(); // 更新队伍显示（应为空）

                // 重置按钮状态
                startBattleBtn.disabled = true; // 开始按钮禁用
                resetBtn.disabled = false; // 重置按钮启用

                // 隐藏战斗区域
                battleSection.classList.add('hidden');

                // 清空战斗日志（或保留并添加分隔符）
                // battleLog.innerHTML = ''; // 完全清空
                 battleLog.innerHTML += '<p style="border-top: 1px dashed #ccc; margin-top: 10px; padding-top: 10px;">===== 战斗已重置 =====</p>';


                // 重置状态显示
                playerTeamName.textContent = '玩家队伍';
                playerTeamStatus.textContent = '-';
                playerTeamMembersStatusContainer.innerHTML = '';
                updateBossStatus(null); // 使用 null 重置 BOSS 显示

                logMessage("战斗已重置。请重新选择。");
            }

            // --- 工具函数 ---
            // 日志记录
            function logMessage(message, type = 'info') {
                const logEntry = document.createElement('p');
                const timestamp = new Date().toLocaleTimeString();
                logEntry.innerHTML = `<span style="color: #999;">[${timestamp}]</span> ${message}`; // 时间戳颜色区分
                if (type === 'error') {
                    logEntry.style.color = 'red';
                    logEntry.style.fontWeight = 'bold';
                    console.error(timestamp, message);
                } else if (type === 'warning') {
                    logEntry.style.color = 'orange';
                    console.warn(timestamp, message);
                } else if (type === 'success') {
                     logEntry.style.color = 'green';
                     logEntry.style.fontWeight = 'bold';
                } else if (type === 'debug') {
                    logEntry.style.color = 'blue'; //  Debug messages in blue
                    console.debug(timestamp, message);
                } else if (type === 'event') {
                    logEntry.style.color = 'purple'; // Event messages in purple
                    console.info(timestamp, `EVENT: ${message}`);
                }
                // 插入到日志顶部而不是底部，最新的在上面
                // battleLog.appendChild(logEntry);
                battleLog.insertBefore(logEntry, battleLog.firstChild);
                // battleLog.scrollTop = battleLog.scrollHeight; // 滚动到底部 (如果插入顶部则不需要)
            }

            // --- 启动应用 ---
            document.addEventListener('DOMContentLoaded', init);

        })();
    </script>

</body>
</html>
